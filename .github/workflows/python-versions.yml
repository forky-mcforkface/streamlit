name: Test Python Versions

on: [push]

jobs:
  build:

    runs-on: ubuntu-latest

    env:
      SUDO: 'sudo'
      BASH_ENV: $HOME/.bash_profile
    
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.7.12", "3.10.0"]
    
    steps:
      - name: Checkout Streamlit code
        uses: actions/checkout@v3
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      - name: Update Submodules
        uses: ./.github/actions/update_submodules
      - name: Run pre-cache
        uses: ./.github/actions/pre_cache
      - name: Run pre-make
        uses: ./.github/actions/pre_make
      - name: Run make init
        uses: ./.github/actions/make_init
      - name: Run make develop
        run: |
          make develop
        shell: bash -l -v -e -u -o pipefail {0}
      - name: Register Mapbox Token
        run: |
          if [ ! -d $HOME/.streamlit ] ; then
              mkdir $HOME/.streamlit
          fi
          MAPBOX_TOKEN=$(curl -sS https://data.streamlit.io/tokens.json | jq -r '.["mapbox-localhost"]') \
          && echo '[mapbox]' >  ~/.streamlit/config.toml \
          && echo 'token = "'$MAPBOX_TOKEN'"' >> ~/.streamlit/config.toml
        shell: bash -l -v -e -u -o pipefail {0}
      - name: Register Streamlit User
        run: |
          echo '[general]' >  ~/.streamlit/credentials.toml
          echo 'email = "test@streamlit.io"' >> ~/.streamlit/credentials.toml
        shell: bash -l -v -e -u -o pipefail {0}
      - name: Run Linters
        run: |
          # TODO: ADD ABILITY TO ACTUALLY SEE WHAT THE LINT PROBLEM IS
          source $HOME/.bash_profile
          # Run eslint as a standalone command to generate the test report.
          PRE_COMMIT_NO_CONCURRENCY=true DISABLE=eslint pipenv run pre-commit run --show-diff-on-failure --color=always --all-files
          make jslint
        shell: bash -l -v -e -u -o pipefail {0}
      - name: Store Lint Results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: lint_results
          path: frontend/test-reports
      - name: Run Type Checkers
        run: |
          source $HOME/.bash_profile
          make tstypecheck
          scripts/mypy --report
        shell: bash -l -v -e -u -o pipefail {0}
      - name: Store Type Check Results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: type_check_results
          path: lib/test-reports
      - name: Run Python Tests
        run: |
          source $HOME/.bash_profile
          if [ ${{ matrix.python-version }} == 3.7.12 ]; then
            ${SUDO} apt-get install python3-pydot python3-pydot-ng graphviz
          fi
          make pycoverage
        shell: bash -l -v -e -u -o pipefail {0}
      - name: Store Python Test Results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: python_test_results
          path: lib/test-reports
      - name: Run Integration Tests
        run: |
          source $HOME/.bash_profile
          make integration-tests
        shell: bash -l -v -e -u -o pipefail {0}
      - name: CLI Smoke Tests
        run: |
          source $HOME/.bash_profile
          make cli-smoke-tests
        shell: bash -l -v -e -u -o pipefail {0}
